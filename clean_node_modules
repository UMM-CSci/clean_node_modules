#!/usr/bin/env bash

num_node_modules=0
num_ignored=0
num_not_ignored=0
while read -r -d $'\0' file
do
    # There should probably be a `--verbose` flag, and we'd print this if 
    # that was set.
    # echo "Checking $file"
    ((++num_node_modules))
    pushd "$(dirname "$file")" &> /dev/null || exit 1
    if git rev-parse --git-dir > /dev/null 2>&1 && git check-ignore --quiet "$(basename "$file")"; then
        echo "We would delete $file"
        ((++num_ignored))
    else
        ((++num_not_ignored))
    fi
    popd &> /dev/null || exit 1
done < <(find "$1" -name node_modules -type d -atime +90 -prune -print0 2>/dev/null)

# Probably only want this if the `--summary` flag is set (or maybe that's the
# default and there should be a `--no-summary` option?). Should probably move
# this into a function as well.
echo
echo "There were $num_node_modules 'node_modules' directories."
echo "We would delete $num_ignored of these."
echo "There were $num_not_ignored that were not ignored and would not be deleted"